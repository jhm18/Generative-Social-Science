ECHO OFF

.   Prefroming a Weighted Sampling in R
.   Jonathan H. Morgan
.   19 June 2021

.   Function takes two arguments: x, n_sample replace, weights
.   x refers to the variable you are sampling.
.   n_sample the number of items from which to sample.
.   replace refers to sampling with and without replacement.
.   weights are probability weights used to generate weighted draws from the sample.

.   Function returns weighted samples as a .DAT file, samples.DAT, which is read into Dataplot.

COMMENT Writing-Out Data and Commands
    .   Writing-Out Replace Command
        CAPTURE replace.dat
            WRITE replace
        END OF CAPTURE

    .   Writing-Out Size Command
        CAPTURE n_sample.dat
            WRITE n_sample
        END OF CAPTURE

    .   Writing-Out Sample Data
        SET WRITE DECIMALS 5
        CAPTURE sample_data.csv
            WRITE x
        END OF CAPTURE

    .   Writing-Out weights
        CAPTURE sample_weights.csv
            WRITE weights
        END OF CAPTURE
    
COMMENT Specifying R script
    CAPTURE SCRIPT weighted_sampling.R
        #   Installing Necessary Packages
            list.of.packages <- c('readr')
            new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]

            if(length(new.packages)) install.packages(new.packages)
            rm(list.of.packages, new.packages)

        #   Specifying a quick function to clean-up the directory string
            trim <- function (x) gsub("^\\s+|\\s+$", "", x)

        #   Getting Replace Specification
            replace_spec <- readLines("replace.dat")
            replace_spec <- strsplit(replace_spec, "--")[[4]][[2]]
            replace_spec <- as.logical(replace_spec)

        #   Getting sample size
            sample_n <- readLines("n_sample.dat")
            sample_n <- strsplit(sample_n, "--")[[4]][[2]]
            sample_n <- as.numeric(sample_n)
  
        #   Importing Sample Data
            sample <- readr::read_csv("sample_data.csv",skip = 3)
            sample <- as.numeric(sample[[1]])
  
        #   Importing Weights
            sample_weights <- readr::read_csv("sample_weights.csv",skip = 3)
            sample_weights <- as.numeric(sample_weights[[1]])
  
        #   Sampling Data
            sample_data = base::sample(sample, prob=sample_weights, size=sample_n, replace=replace_spec)

        #   Writing Out Samples
            sample_data <- as.character(sample_data)
            fileConn<-file("samples.DAT")
            writeLines(sample_data, fileConn)
    END OF CAPTURE

COMMENT Executing Program
    RSCRIPT  weighted_sampling.R

COMMENT Reading-In Samples
    READ samples.DAT samples

COMMENT Remove Files
    RM replace.dat
    RM n_sample.dat
    RM weighted_sampling.R sample_data.csv sample_weights.csv samples.DAT

ECHO ON